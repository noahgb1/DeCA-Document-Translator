@page
@model DocumentTranslation.Web.Pages.TranslateModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<style>
/* Keep primary-blue active state for the Files/Folder toggle */
#modeToggle .btn-check:checked + .btn-outline-secondary,
#modeToggle .btn-outline-secondary.active {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}
#modeToggle .btn-outline-secondary:hover {
    color: #fff;
    background-color: #0b5ed7;
    border-color: #0b5ed7;
}
</style>

<div class="container py-4">

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger"><i class="fa-solid fa-triangle-exclamation me-2"></i>@Model.ErrorMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success"><i class="fa-solid fa-circle-check me-2"></i>@Model.Message</div>
    }

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white d-flex align-items-center">
            <i class="fa-solid fa-language me-2" aria-hidden="true"></i>
            <h3 class="mb-0">Document Translation</h3>
        </div>

        <div class="card-body">
            <form method="post" enctype="multipart/form-data">

                <!-- Dynamic helper (black, default font size) -->
                <div class="mb-2">
                    <span id="modeHelp" class="fw-semibold text-dark">Select one or more files.</span>
                </div>

                <!-- Files/Folder toggle -->
                <div class="mb-2 d-flex align-items-center justify-content-between">
                    <div id="modeToggle" class="btn-group" role="group" aria-label="Selection mode">
                        <input type="radio" class="btn-check" name="pickMode" id="modeFiles" value="files" autocomplete="off" checked>
                        <label class="btn btn-outline-secondary btn-sm" for="modeFiles">Files</label>

                        <input type="radio" class="btn-check" name="pickMode" id="modeFolder" value="folder" autocomplete="off">
                        <label class="btn btn-outline-secondary btn-sm" for="modeFolder">Folder</label>
                    </div>
                </div>

                <div class="mb-3">
                    <input type="file"
                           id="fileChooser"
                           class="form-control"
                           asp-for="UploadedFiles"
                           accept=".docx,.pdf,.pptx,.xlsx,.txt,.html,.htm,.md"
                           multiple>
                    <small class="form-text text-muted" id="chooserHint">
                        Supported formats: Word (.docx), PDF, PowerPoint (.pptx), Excel (.xlsx), Text (.txt), HTML, Markdown. Use Ctrl/Shift to select multiple files.
                    </small>
                    <span asp-validation-for="UploadedFiles" class="text-danger"></span>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label asp-for="SourceLanguage" class="form-label">
                            <i class="fa-solid fa-globe me-1" aria-hidden="true"></i> Source Language (Optional)
                        </label>
                        <select asp-for="SourceLanguage" class="form-select">
                            <option value="">Auto-detect</option>
                            @foreach (var lang in Model.AvailableLanguages)
                            {
                                <option value="@lang.Code">@lang.Name</option>
                            }
                        </select>
                        <small class="form-text text-muted">Leave blank for automatic language detection</small>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="TargetLanguage" class="form-label">
                            <i class="fa-solid fa-flag me-1" aria-hidden="true"></i> Target Language *
                        </label>
                        <select asp-for="TargetLanguage" class="form-select">
                            @foreach (var lang in Model.AvailableLanguages)
                            {
                                <option value="@lang.Code" selected="@(Model.TargetLanguage == lang.Code)">@lang.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <button type="submit" id="translateBtn" class="btn btn-primary btn-lg w-100 mt-2" aria-label="Translate Document">
                    <i class="fa-solid fa-language me-2" aria-hidden="true"></i> <span class="btn-label">Translate Document</span>
                </button>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header d-flex align-items-center">
            <i class="fa-solid fa-circle-info me-2" aria-hidden="true"></i>
            <h5 class="mb-0">How it works</h5>
        </div>
        <div class="card-body">
            <ol class="mb-0">
                <li>Toggle between <strong>"Files"</strong> (default) and <strong>"Folder"</strong> modes to select individual files or an entire folder for upload.</li>
                <li>Select and upload your document/s using the <strong>"Choose File"</strong> selector.</li>
                <li>Choose the source language using <strong>"Source Language"</strong>. This defaults to <strong>"Auto Detect"</strong> if no language is specified.</li>
                <li>Select the target language using <strong>"Target Language"</strong>.</li>
                <li>Click <strong>"Translate Document"</strong> to begin translation.</li>
                <li>Depending on file size, type, and content complexity (e.g., images, formatting), translation may take several minutes.</li>
                <li>Once complete, open or download your translated document/s.</li>
            </ol>
            <div class="text-muted small mt-3">
                <i class="fa-solid fa-shield-halved me-1" aria-hidden="true"></i>
                Your documents are processed securely and temporarily stored only during translation.
            </div>
        </div>
    </div>

    @if (Model.TranslatedFiles != null && Model.TranslatedFiles.Count > 0)
    {
        <hr class="my-4" />
        <h5>Translated Files</h5>
        <ul class="list-group">
            @foreach (var f in Model.TranslatedFiles)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-file me-2" aria-hidden="true"></i>@f</span>
                    <a class="btn btn-sm btn-outline-secondary" href="?handler=Download&fileName=@Uri.EscapeDataString(f)"><i class="fa-solid fa-download me-1" aria-hidden="true"></i>Download</a>
                </li>
            }
        </ul>
        <a class="btn btn-success mt-3" href="?handler=DownloadAll"><i class="fa-solid fa-file-zipper me-1" aria-hidden="true"></i>Download All as .zip</a>
    }
</div>

<script>
(function() {
    const chooser = document.getElementById('fileChooser');
    const modeFiles = document.getElementById('modeFiles');
    const modeFolder = document.getElementById('modeFolder');
    const chooserHint  = document.getElementById('chooserHint');
    const modeHelp     = document.getElementById('modeHelp');
    const btn          = document.getElementById('translateBtn');
    const labelSpan    = btn ? btn.querySelector('.btn-label') : null;

    function setMode(mode) {
        if (!chooser) return;
        if (mode === 'folder') {
            chooser.removeAttribute('multiple');
            chooser.setAttribute('webkitdirectory', '');
            chooserHint.textContent = 'All supported files in the selected folder (and subfolders) will be uploaded.';
            modeHelp.textContent = 'Select a folder to upload its contents.';
            chooser.value = '';
        } else {
            chooser.setAttribute('multiple', '');
            chooser.removeAttribute('webkitdirectory');
            chooserHint.textContent = 'Supported formats: Word (.docx), PDF, PowerPoint (.pptx), Excel (.xlsx), Text (.txt), HTML, Markdown. Use Ctrl/Shift to select multiple files.';
            modeHelp.textContent = 'Select one or more files.';
            chooser.value = '';
        }
        updateButton();
    }

    function updateButton() {
        const filesCount = chooser && chooser.files ? chooser.files.length : 0;
        const isFolderMode = modeFolder && modeFolder.checked;
        let text;

        if (isFolderMode && filesCount > 0) {
            text = 'Translate Folder';
        } else if (!isFolderMode && filesCount > 1) {
            text = 'Translate Documents';
        } else {
            text = 'Translate Document';
        }

        if (labelSpan) labelSpan.textContent = text;
        if (btn) btn.setAttribute('aria-label', text + (filesCount ? ` (${filesCount} selected)` : ''));
    }

    if (modeFiles) modeFiles.addEventListener('change', () => setMode('files'));
    if (modeFolder) modeFolder.addEventListener('change', () => setMode('folder'));
    if (chooser) chooser.addEventListener('change', updateButton);

    document.addEventListener('DOMContentLoaded', () => setMode('files'));
})();
</script>